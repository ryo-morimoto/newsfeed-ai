# E2E Testing Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Playwright による E2E テスト基盤を構築し、PR 時のリグレッションテストと本番リリース後のスモークテストを自動化する。

**Architecture:** Playwright で外部 URL (Preview/Production) に対してテスト実行。GitHub Actions で PR 時は Preview URL、main マージ後は本番 URL をテスト。

**Tech Stack:** Playwright, GitHub Actions, Cloudflare Workers

---

## Task 1: Playwright セットアップ

**Files:**
- Modify: `apps/web/package.json`
- Create: `apps/web/e2e/playwright.config.ts`

**Step 1: Playwright を devDependencies に追加**

```bash
cd apps/web && bun add -d @playwright/test
```

**Step 2: Playwright 設定ファイルを作成**

```typescript
// apps/web/e2e/playwright.config.ts
import { defineConfig, devices } from "@playwright/test";

const baseURL = process.env.E2E_BASE_URL || "https://newsfeed-ai.ryo-o.dev";

export default defineConfig({
  testDir: "./tests",
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: process.env.CI ? "github" : "list",
  timeout: 30000,
  use: {
    baseURL,
    trace: "on-first-retry",
  },
  projects: [
    {
      name: "chromium",
      use: { ...devices["Desktop Chrome"] },
    },
  ],
});
```

**Step 3: package.json にスクリプト追加**

`apps/web/package.json` の `scripts` に追加:

```json
{
  "scripts": {
    "test:e2e": "playwright test -c e2e/playwright.config.ts",
    "test:e2e:ui": "playwright test -c e2e/playwright.config.ts --ui",
    "test:e2e:smoke": "playwright test -c e2e/playwright.config.ts smoke.spec.ts"
  }
}
```

**Step 4: コミット**

```bash
git add apps/web/package.json apps/web/e2e/playwright.config.ts bun.lock
git commit -m "chore(web): add Playwright for E2E testing"
```

---

## Task 2: スモークテスト作成

**Files:**
- Create: `apps/web/e2e/tests/smoke.spec.ts`

**Step 1: スモークテストを作成**

```typescript
// apps/web/e2e/tests/smoke.spec.ts
import { test, expect } from "@playwright/test";

test.describe("Smoke Tests", () => {
  test("index page returns 200 and has heading", async ({ page }) => {
    const response = await page.goto("/");
    expect(response?.status()).toBe(200);
    await expect(page.locator("h1")).toContainText("記事一覧");
  });

  test("search page returns 200 and has search form", async ({ page }) => {
    const response = await page.goto("/search");
    expect(response?.status()).toBe(200);
    await expect(page.locator('input[type="search"]')).toBeVisible();
    await expect(page.locator('button[type="submit"]')).toBeVisible();
  });

  test("non-existent article returns 404", async ({ page }) => {
    const response = await page.goto("/article/https%3A%2F%2Fnon-existent-url.example.com");
    expect(response?.status()).toBe(404);
    await expect(page.locator("h1")).toContainText("404");
  });
});
```

**Step 2: テスト実行して確認**

Run: `cd apps/web && bun run test:e2e:smoke`
Expected: 3 tests pass

**Step 3: コミット**

```bash
git add apps/web/e2e/tests/smoke.spec.ts
git commit -m "test(web): add E2E smoke tests"
```

---

## Task 3: トップページ詳細テスト

**Files:**
- Create: `apps/web/e2e/tests/pages/index.spec.ts`

**Step 1: トップページテストを作成**

```typescript
// apps/web/e2e/tests/pages/index.spec.ts
import { test, expect } from "@playwright/test";

test.describe("Index Page", () => {
  test.beforeEach(async ({ page }) => {
    await page.goto("/");
  });

  test("has correct title", async ({ page }) => {
    await expect(page).toHaveTitle(/Newsfeed AI/);
  });

  test("has header navigation", async ({ page }) => {
    const nav = page.locator("header nav");
    await expect(nav.getByRole("link", { name: "記事一覧" })).toBeVisible();
    await expect(nav.getByRole("link", { name: "検索" })).toBeVisible();
  });

  test("has article cards or empty message", async ({ page }) => {
    const articles = page.locator("article");
    const emptyMessage = page.getByText("詳細要旨が生成された記事はまだありません");

    const hasArticles = await articles.count() > 0;
    const hasEmptyMessage = await emptyMessage.isVisible().catch(() => false);

    expect(hasArticles || hasEmptyMessage).toBe(true);
  });

  test("has footer", async ({ page }) => {
    await expect(page.locator("footer")).toBeVisible();
    await expect(page.locator("footer")).toContainText("Newsfeed AI");
  });
});
```

**Step 2: テスト実行**

Run: `cd apps/web && bun run test:e2e`
Expected: All tests pass

**Step 3: コミット**

```bash
git add apps/web/e2e/tests/pages/index.spec.ts
git commit -m "test(web): add index page E2E tests"
```

---

## Task 4: 検索ページテスト

**Files:**
- Create: `apps/web/e2e/tests/pages/search.spec.ts`

**Step 1: 検索ページテストを作成**

```typescript
// apps/web/e2e/tests/pages/search.spec.ts
import { test, expect } from "@playwright/test";

test.describe("Search Page", () => {
  test("has search form", async ({ page }) => {
    await page.goto("/search");

    await expect(page.locator('input[type="search"]')).toBeVisible();
    await expect(page.locator('button[type="submit"]')).toBeVisible();
  });

  test("shows prompt message when no query", async ({ page }) => {
    await page.goto("/search");

    await expect(page.getByText("キーワードを入力して検索してください")).toBeVisible();
  });

  test("shows results or no-results message with query", async ({ page }) => {
    await page.goto("/search?q=test");

    const results = page.locator("article");
    const noResults = page.getByText("該当する記事が見つかりませんでした");

    const hasResults = await results.count() > 0;
    const hasNoResults = await noResults.isVisible().catch(() => false);

    expect(hasResults || hasNoResults).toBe(true);
  });

  test("shows result count with query", async ({ page }) => {
    await page.goto("/search?q=test");

    await expect(page.getByText(/の検索結果:/)).toBeVisible();
  });
});
```

**Step 2: テスト実行**

Run: `cd apps/web && bun run test:e2e`
Expected: All tests pass

**Step 3: コミット**

```bash
git add apps/web/e2e/tests/pages/search.spec.ts
git commit -m "test(web): add search page E2E tests"
```

---

## Task 5: 記事詳細ページテスト

**Files:**
- Create: `apps/web/e2e/tests/pages/article.spec.ts`

**Step 1: 記事詳細ページテストを作成**

```typescript
// apps/web/e2e/tests/pages/article.spec.ts
import { test, expect } from "@playwright/test";

test.describe("Article Page", () => {
  test("shows 404 for non-existent article", async ({ page }) => {
    await page.goto("/article/https%3A%2F%2Fnon-existent.example.com");

    await expect(page.locator("h1")).toContainText("404");
    await expect(page.getByText("記事が見つかりませんでした")).toBeVisible();
  });

  test("has back link on 404 page", async ({ page }) => {
    await page.goto("/article/https%3A%2F%2Fnon-existent.example.com");

    await expect(page.getByRole("link", { name: /記事一覧に戻る/ })).toBeVisible();
  });

  test("article page has required elements when article exists", async ({ page }) => {
    // First, get an article URL from the index page
    await page.goto("/");

    const firstArticleLink = page.locator("article a").first();
    const hasArticle = await firstArticleLink.count() > 0;

    if (!hasArticle) {
      test.skip(true, "No articles in database");
      return;
    }

    await firstArticleLink.click();
    await page.waitForLoadState("networkidle");

    // Check article page elements
    await expect(page.locator("h1")).toBeVisible();
    await expect(page.getByRole("link", { name: /記事一覧に戻る/ })).toBeVisible();
    await expect(page.getByRole("link", { name: /元の記事を読む/ })).toBeVisible();
  });
});
```

**Step 2: テスト実行**

Run: `cd apps/web && bun run test:e2e`
Expected: All tests pass

**Step 3: コミット**

```bash
git add apps/web/e2e/tests/pages/article.spec.ts
git commit -m "test(web): add article page E2E tests"
```

---

## Task 6: GitHub Actions - 本番スモークテスト

**Files:**
- Create: `.github/workflows/e2e-production.yml`

**Step 1: ワークフローファイル作成**

```yaml
# .github/workflows/e2e-production.yml
name: E2E Production Smoke Tests

on:
  push:
    branches: [main]
    paths:
      - "apps/web/**"
      - ".github/workflows/e2e-production.yml"
  workflow_dispatch:

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install Playwright browsers
        run: bunx playwright install chromium
        working-directory: apps/web

      - name: Wait for deployment
        run: sleep 30

      - name: Run smoke tests
        run: bun run test:e2e:smoke
        working-directory: apps/web
        env:
          E2E_BASE_URL: https://newsfeed-ai.ryo-o.dev

      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 7
```

**Step 2: コミット**

```bash
git add .github/workflows/e2e-production.yml
git commit -m "ci: add E2E production smoke tests workflow"
```

---

## Task 7: GitHub Actions - Preview リグレッションテスト

**Files:**
- Create: `.github/workflows/e2e-preview.yml`

**Step 1: ワークフローファイル作成**

```yaml
# .github/workflows/e2e-preview.yml
name: E2E Preview Tests

on:
  pull_request:
    paths:
      - "apps/web/**"
      - ".github/workflows/e2e-preview.yml"

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install Playwright browsers
        run: bunx playwright install chromium
        working-directory: apps/web

      - name: Deploy to Preview
        id: deploy
        run: |
          cd apps/web
          bun run build
          DEPLOY_OUTPUT=$(bunx wrangler deploy 2>&1)
          echo "$DEPLOY_OUTPUT"
          PREVIEW_URL=$(echo "$DEPLOY_OUTPUT" | grep -oP 'https://[^\s]+\.workers\.dev' | head -1)
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Wait for Preview deployment
        run: sleep 10

      - name: Run E2E tests
        run: bun run test:e2e
        working-directory: apps/web
        env:
          E2E_BASE_URL: ${{ steps.deploy.outputs.preview_url }}

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 7

      - name: Comment PR with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '✅' : '❌';
            const url = '${{ steps.deploy.outputs.preview_url }}';
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## E2E Test Results ${status}\n\n**Preview URL:** ${url}\n**Status:** ${{ job.status }}`
            });
```

**Step 2: コミット**

```bash
git add .github/workflows/e2e-preview.yml
git commit -m "ci: add E2E preview tests workflow"
```

---

## Task 8: 動作確認

**Step 1: ローカルでスモークテスト実行**

Run: `cd apps/web && bun run test:e2e:smoke`
Expected: 3 tests pass

**Step 2: 全テスト実行**

Run: `cd apps/web && bun run test:e2e`
Expected: All tests pass

**Step 3: 最終コミット**

```bash
git add -A
git commit -m "feat(web): complete E2E testing setup"
```

---

## Summary

- [x] Playwright セットアップ
- [x] スモークテスト (3 tests)
- [x] トップページテスト (4 tests)
- [x] 検索ページテスト (4 tests)
- [x] 記事詳細ページテスト (3 tests)
- [x] GitHub Actions - 本番スモークテスト
- [x] GitHub Actions - Preview リグレッションテスト
